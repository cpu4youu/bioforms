import{s as styled,f as ee,w as rpc,S as SMART_CONTRACTS,v as TABLES,e as QUERY_KEYS,u as useAuthStore,g as getTable,R as React,j as jsxRuntimeExports,_ as __vitePreload,b as useMapStore,r as reactExports,Q}from"./index-79e9db7e.js";import{u as useInventoryQuery}from"./inventory-query-4269238e.js";import{u as useQuery}from"./useQuery-dc7c5337.js";import{u as useTransaction}from"./use-transaction-0358c116.js";import{s as sleep}from"./sleep-da79c358.js";import{o as onRefetchFighters}from"./fighters-query-bf76ca11.js";import InventoryCard$1 from"./index-5797bcbd.js";import{u as useMedia}from"./use-media-965172e4.js";import"./adapters-964f8bbe.js";import"./atomic-api-cfb64dad.js";import"./toast-options-7e30d8e2.js";const Wrapper=styled("div",{d:"flex",align:"center",justify:"center",direction:"column",position:"relative",w:"100%"}),Header=styled("div",{d:"flex",align:"flex-end",justify:"flex-end",gap:"10px",position:"relative",w:"100%",button:{d:"flex",align:"center",justify:"center",w:"auto",maxW:"170px",h:"70px",svg:{fill:"#00BAFF"},span:{d:"flex",align:"center",justify:"center",gap:"5px",color:"#828282"},img:{maxW:"35px",maxH:"30px"}},"@sm":{button:{justify:"center",gap:"2px",maxW:"33%",h:"45px",padding:"5px 20px",fs:"12px",span:{gap:"0px"},svg:{display:"none"}}}}),ContentWrapper=styled("div",{d:"flex",align:"flex-start",justify:"center",gap:"10px",w:"100%",h:"calc(100vh - 160px)",minH:"calc(100vh - 160px)",maxH:"calc(100vh - 160px)",mt:"10px"}),Container=styled("div",{d:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-start",gap:"20px",padding:"15px 10px",br:"15px",w:"100%",h:"100%",bg:"#141423",backgroundImage:"url(/assets/background/bg-tavern.png)",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",variants:{isHidden:{true:{display:"none"}}}}),CardContainer=styled("div",{display:"flex",alignItems:"center",justifyContent:"center",gap:"15px",img:{"-webkit-filter":"drop-shadow(0px 0px 8px #fff)",filter:"drop-shadow(0px 0px 5px #fff)","&:hover":{transform:"scale(1.05)",zIndex:"4","-webkit-filter":"drop-shadow(0px 0px 8px #00BAFF)",filter:"drop-shadow(0px 0px 5px #00BAFF)"}},variants:{cardSelected:{0:{img:{"&:nth-of-type(1)":{zIndex:"3"},"&:nth-of-type(2)":{opacity:"0.2"},"&:nth-of-type(3)":{opacity:"0.2"}}},1:{img:{"&:nth-of-type(1)":{opacity:"0.2"},"&:nth-of-type(2)":{},"&:nth-of-type(3)":{opacity:"0.2"}}},2:{img:{"&:nth-of-type(1)":{opacity:"0.2"},"&:nth-of-type(2)":{opacity:"0.2"},"&:nth-of-type(3)":{}}}}}});styled("img",{cursor:"pointer",transition:"all 0.2s ease-in-out",w:"100px",h:"145px",zIndex:"2",variants:{isSelected:{true:{filter:"grayscale(100%)"}}}});const shimmer=ee({"0%":{backgroundPosition:"0% 0%"},"100%":{backgroundPosition:"-135% 0%"}}),CardLoading=styled("div",{w:"120px",h:"170px",background:"linear-gradient( -90deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.25) ,rgba(255, 255, 255, 0.15))",br:"10px",backgroundSize:"400% 400%",animation:`${shimmer} 1.2s ease-in-out infinite`,"@sm":{width:"70px",height:"100px"}}),getTavernTemplateTable=async()=>{var n,l;let e=!1,t;const s=[];for(;!e;){const r=await rpc.get_table_rows({code:SMART_CONTRACTS.ADVENTURE_MC,index_position:1,limit:"10000",scope:SMART_CONTRACTS.ADVENTURE_MC,table:TABLES.ADV_TEMPLATES,show_payer:!1,json:!0,lower_bound:t});e=!r.more,s.push(...r.rows.slice(0,-1)),t=((l=(n=r.rows)==null?void 0:n[r.rows.length-1])==null?void 0:l.templateid)??""}return s},useTavernTemplateQuery=()=>useQuery({queryKey:[QUERY_KEYS.tavernDataState],queryFn:()=>onFetch$1(),staleTime:1e3*60*60,enabled:!!useAuthStore.getState().user});async function onFetch$1(){try{const e=await getTavernTemplateTable();return e?formattedTemplateData(e):null}catch(e){return console.log(e),null}}function formattedTemplateData(e){return e.map(t=>({...t,"nft.mp":t.nft_mp,"tlm.mp":t.tlm_mp}))}const getTavernConfigTable=async()=>await getTable({options:{code:SMART_CONTRACTS.tavernAle,index_position:1,limit:"1000",scope:SMART_CONTRACTS.tavernAle,table:TABLES.CONFIG}}),useTavernConfigQuery=()=>useQuery({queryKey:[QUERY_KEYS.tavernConfigState],queryFn:()=>onFetch(),staleTime:1e3*60*60,enabled:!!useAuthStore.getState().user});async function onFetch(){try{const e=await getTavernConfigTable();return e||null}catch(e){return console.log(e),null}}async function executeRevealContract(e,t){const{executeTransaction:s}=useTransaction(),n=buildTransaction$1(e,t);return!!await s(n)}function buildTransaction$1(e,t){return{actions:[{account:SMART_CONTRACTS.tavernAle,name:"reveal",authorization:[{actor:e.name,permission:e.authorization.permission}],data:{wallet:e.name,use_gems:t}}]}}async function executeHireContract(e,t,s){const{executeTransaction:n}=useTransaction(),l=buildTransaction(e,t,s);return!!await n(l)}function buildTransaction(e,t,s){return{actions:[{account:SMART_CONTRACTS.playersAle,name:"hire",authorization:[{actor:e.name,permission:e.authorization.permission}],data:{wallet:e.name,asset_ids:t,cost_action_points:s}}]}}const InventoryContainer$1=styled("div",{gridArea:"inventory",display:"flex",direction:"column",bg:"#1D1B20",br:"8px",w:"100%",h:"100%",maxH:"calc(100vh -675px)",span:{my:"auto",ff:"$heading",fs:"26px",fw:"bold",color:"#fff",textAlign:"center"},"@sm":{mt:"0px"}}),Tabs=styled("div",{d:"flex",gap:"20px",padding:"20px","@sm":{m:"0px 0 20px",gap:"10px"}}),ButtonTabs=styled("button",{fs:"14px",ff:"$heading",fw:"$bold",color:"#CACACA",variants:{isSelected:{true:{textUnderlineOffset:"0.5em",textDecoration:"underline",color:"#36B9EA"}}},"@sm":{fs:"14px"}}),InventoryCards=styled("div",{d:"flex",flexWrap:"wrap",gap:"10px",overflow:"auto",border:"1px solid #4A4459",padding:"20px",w:"100%",maxH:"calc(100vh - 520px)"}),CardImage=styled("img",{cursor:"pointer",transition:"all 0.2s ease-in-out",w:"120px",h:"170px",zIndex:"2",variants:{isSelected:{true:{filter:"grayscale(100%)"}}},"@lg":{w:"100px",h:"150px"},"@sm":{width:"80px",height:"initial"},"@xsm":{width:"70px",height:"initial"}}),INVENTORY_TABS=[{key:"tool.worlds",label:"Tools"},{key:"crew.worlds",label:"Crew"},{key:"arms.worlds",label:"Weapons"},{key:"level.worlds",label:"Levels"},{key:"faces.worlds",label:"Avatars"}],InventoryContainer=React.memo(({isInventoryLoading:e,filteredInventory:t,handleSelectCard:s,selectedCards:n,inventoryPosition:l,inventoryFilter:r,setInventoryFilter:o})=>jsxRuntimeExports.jsx(InventoryContainer$1,{children:n.length!==0&&l===-1?jsxRuntimeExports.jsx("span",{children:"Select a card"}):jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(Tabs,{children:INVENTORY_TABS.map(a=>jsxRuntimeExports.jsx(ButtonTabs,{isSelected:r===a.key,onClick:()=>o(a.key),children:a.label},a.key))}),jsxRuntimeExports.jsx(InventoryCards,{children:e?Array.from({length:10}).map((a,i)=>jsxRuntimeExports.jsx(CardLoading,{},i)):jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(CardImage,{onClick:()=>s(void 0),src:"/assets/default-card.png",alt:"default card"}),t==null?void 0:t.map(a=>jsxRuntimeExports.jsx(InventoryCard$1,{item:a,isSelected:n.some(i=>(i==null?void 0:i.asset_id)===(a==null?void 0:a.asset_id)),onClick:()=>s(a)},a.asset_id))]})})]})}));InventoryContainer.displayName="InventoryContainer";const ObjectivesContainer$1=styled("div",{display:"flex",alignItems:"center",justifyContent:"center",flexWrap:"wrap",gap:"5px",w:"100%","@sm":{flexDirection:"row"}}),Objective=styled("div",{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",w:"100%",maxW:"82px",h:"85px",padding:"5px 0px 0px",bg:"#358CAC",br:"3px",span:{color:"#fff",ff:"$heading",fs:"10px","&:first-child":{fontWeight:"bold",color:"#07445A",mb:"12px"}},variants:{disabled:{true:{bg:"#7e7e7eff","span:first-child":{color:"#fff"},"span:last-child":{color:"#afafafff"},">div":{bg:"#505050ff",">img":{filter:"grayscale(100%)"}}}},isSelected:{true:{boxShadow:"0 0 10px 2px rgb(0, 186, 255)"}}}}),ObjectiveValue=styled("div",{display:"flex",alignItems:"center",gap:"5px",mt:"auto",padding:"5px 10px",color:"#fff",ff:"$heading",fs:"14px",br:"3px",bg:"#17566D",w:"100%",img:{w:"16px",objectFit:"contain"}});function formatObjectiveValue(e,t,s){return e==="tlm.mp"||e==="nft.mp"?(t/10).toFixed(1):s==="-"?t:s}const ObjectivesContainer=React.memo(({areaSelected:e,selectedBonus:t,selectedFilter:s,setSelectedFilter:n})=>{var o;function l({objective_string:a,objective_type:i,objective_value:d}){const c=formatObjectiveValue(i,d,a);if(s.some(u=>(u==null?void 0:u.type)===i&&u.value===c)){const u=s.filter(p=>p.value!==c||(p==null?void 0:p.type)!==i);n(u);return}n([...s,{type:i,value:c}])}function r({objective_string:a,objective_type:i,objective_value:d}){return!!s.find(c=>(c==null?void 0:c.type)===i&&c.value===formatObjectiveValue(i,d,a))}return jsxRuntimeExports.jsx(ObjectivesContainer$1,{children:(o=e==null?void 0:e.objectives)==null?void 0:o.map(({objective_string:a,objective_type:i,objective_value:d,mod_value:c},u)=>jsxRuntimeExports.jsxs(Objective,{onClick:()=>l({objective_string:a,objective_type:i,objective_value:d}),disabled:!(t!=null&&t[u]),isSelected:r({objective_string:a,objective_type:i,objective_value:d}),children:[jsxRuntimeExports.jsx("span",{children:i}),jsxRuntimeExports.jsx("span",{children:a==="-"?d:a}),jsxRuntimeExports.jsxs(ObjectiveValue,{children:[c,jsxRuntimeExports.jsx("img",{loading:"lazy",src:"/assets/icons/energy.png",alt:""})]})]},u))})});ObjectivesContainer.displayName="ObjectivesContainer";const Button=React.lazy(()=>__vitePreload(()=>import("./index-3d3e0d78.js"),["assets/index-3d3e0d78.js","assets/index-79e9db7e.js","assets/index-55fec1ff.css","assets/index-ae46ad61.js"])),FighterDetail=React.lazy(()=>__vitePreload(()=>import("./index-0593c3e2.js"),["assets/index-0593c3e2.js","assets/index-79e9db7e.js","assets/index-55fec1ff.css","assets/config-query-8ca1f114.js","assets/useQuery-dc7c5337.js","assets/classtemps-query-c1ab7b17.js","assets/resStats-7c9727e3.js"])),InventoryCard=React.lazy(()=>__vitePreload(()=>import("./index-5797bcbd.js"),["assets/index-5797bcbd.js","assets/index-79e9db7e.js","assets/index-55fec1ff.css"])),Tavern=()=>{const{setAreaSelected,areaSelected}=useMapStore(),{user,updatePlayerData,updateLandsData}=useAuthStore(),{isSmall}=useMedia(),[inventoryFilter,setInventoryFilter]=reactExports.useState("level.worlds"),[inventoryPosition,setInventoryPosition]=reactExports.useState(0),[selectedBonus,setSelectedBonus]=reactExports.useState({}),[selectedCards,setSelectedCards]=reactExports.useState([void 0,void 0,void 0]),[isRevealLoading,setIsRevealLoading]=reactExports.useState(!1),[isHireLoading,setIsHireLoading]=reactExports.useState(!1),[isFighterSelected,setIsFighterSelected]=reactExports.useState(!1),[isDetailReveled,setIsDetailReveled]=reactExports.useState(!1),[selectedFilter,setSelectedFilter]=reactExports.useState([]),{data:inventory,isLoading:isInventoryLoading}=useInventoryQuery(inventoryFilter),{data:tavernTemplate}=useTavernTemplateQuery(),{data:tavernConfig}=useTavernConfigQuery();function handleLeaveArena(){setAreaSelected(null)}function handleInventoryPosition(e){if(e===inventoryPosition){setInventoryPosition(-1);return}setInventoryPosition(e)}function handleSelectCard(e){if(!e){const s=selectedCards.map((n,l)=>{if(l!==inventoryPosition)return n});calculateTotalBonus(s),setInventoryPosition(inventoryPosition+1),setSelectedCards(s);return}if(selectedCards.some(s=>(s==null?void 0:s.asset_id)===(e==null?void 0:e.asset_id))){setInventoryPosition(-1);return}const t=selectedCards.map((s,n)=>n===inventoryPosition?e:s);calculateTotalBonus(t),setInventoryPosition(inventoryPosition+1),setSelectedCards(t),inventoryPosition===2&&setInventoryPosition(-1)}function calculateTotalBonus(e){let t={};e.forEach(s=>{const n=tavernTemplate==null?void 0:tavernTemplate.find(r=>(r==null?void 0:r.templateid)===Number(s==null?void 0:s.template.template_id));if(!n||!(areaSelected!=null&&areaSelected.objectives))return;const l=areaSelected.objectives.reduce((r,o,a)=>{if(o.objective_value!==99999&&o.objective_value===(n==null?void 0:n[o.objective_type])){const i=o==null?void 0:o.mod_value;return r[a]=i,r}if(o.objective_type==="element"&&(o.objective_string.toLocaleLowerCase()===(n==null?void 0:n.element.toLocaleLowerCase())||o.objective_string.toLocaleLowerCase()===(n==null?void 0:n.weaponclass.toLocaleLowerCase()))){const i=o==null?void 0:o.mod_value;return r[a]=i,r}if(o.objective_string!=="-"&&o.objective_string.toLocaleLowerCase()===String(n==null?void 0:n[o.objective_type]).toLocaleLowerCase()){const i=o==null?void 0:o.mod_value;return r[a]=i,r}return r},{});t={...t,...l}}),setSelectedBonus(t)}function showRevelCost(){var e,t,s,n,l,r;return!tavernConfig||!user?null:((e=user==null?void 0:user.activestats)==null?void 0:e.gems)>=((t=tavernConfig==null?void 0:tavernConfig[0])==null?void 0:t.cost_reveal_gem)?(s=tavernConfig==null?void 0:tavernConfig[0])==null?void 0:s.cost_reveal_gem:((n=user==null?void 0:user.activestats)==null?void 0:n.credits)>=((l=tavernConfig==null?void 0:tavernConfig[0])==null?void 0:l.cost_reveal_credits)?(r=tavernConfig==null?void 0:tavernConfig[0])==null?void 0:r.cost_reveal_credits:null}async function handleReveal(e){if(!e){setIsFighterSelected(!1),setIsDetailReveled(!1);return}if(tavernFighter){setIsFighterSelected(!0),setIsDetailReveled(!isDetailReveled);return}if(user){setIsRevealLoading(!0);try{await executeRevealContract(user,e)&&(await sleep(4e3),await updatePlayerData(),Q.success("Reveal success"))}catch(t){console.error("Error during reveal:",t),Q.error("Failed to reveal fighter")}finally{setIsRevealLoading(!1)}}}async function handleHire(){if(user){setIsHireLoading(!0);try{await executeHireContract(user,selectedAssetIds,hireCost)&&(await sleep(4e3),await updatePlayerData(),await updateLandsData(),setAreaSelected(null),onRefetchFighters(user.name),Q.success("Hire success"))}catch(e){console.error("Error during hire:",e),Q.error("Failed to hire fighter")}finally{setIsHireLoading(!1)}}}function filterInventoryCards(card){var e,t;const cardTemplate={schema:card.schema.schema_name,...card.data,def:(e=card.data)==null?void 0:e.defense,pow:(t=card.data)==null?void 0:t.difficulty};if(!cardTemplate)return!0;const conditionalString=selectedFilter.reduce((s,{type:n,value:l},r)=>(n=n==="element"&&inventoryFilter==="arms.worlds"?"class":n,n==="tlm.mp"||n==="nft.mp"?s+=` cardTemplate["${n}"] === ${+l*10} ${r===selectedFilter.length-1?"":"&&"}`:typeof l=="number"?s+=` cardTemplate["${n}"] === ${l} ${r===selectedFilter.length-1?"":"&&"}`:s+=` cardTemplate["${n}"] === "${l}" ${r===selectedFilter.length-1?"":"&&"}`,s),"");return conditionalString?eval(conditionalString):!0}const hireCost=reactExports.useMemo(()=>{var t;const e=Array.from({length:10},(s,n)=>selectedBonus[n]||0).reduce((s,n)=>s+n,0);return(((t=tavernConfig==null?void 0:tavernConfig[0])==null?void 0:t.cost_hire_ap)||0)-e},[selectedBonus,tavernConfig]),filteredInventory=reactExports.useMemo(()=>(inventory==null?void 0:inventory.filter(e=>selectedCards.some(t=>(t==null?void 0:t.asset_id)!==e.asset_id)))||[],[inventory,selectedCards]),selectedAssetIds=reactExports.useMemo(()=>selectedCards.filter(e=>!!e).map(e=>Number(e==null?void 0:e.asset_id)),[selectedCards]),isRevealed=reactExports.useMemo(()=>{var e;return(e=user==null?void 0:user.active_taverns)==null?void 0:e.some(t=>t.x===(areaSelected==null?void 0:areaSelected.x)&&t.y===(areaSelected==null?void 0:areaSelected.y))},[user==null?void 0:user.active_taverns,areaSelected==null?void 0:areaSelected.x,areaSelected==null?void 0:areaSelected.y]),tavernFighter=reactExports.useMemo(()=>{var e,t;if(((e=user==null?void 0:user.last_tavern)==null?void 0:e.x)===(areaSelected==null?void 0:areaSelected.x)&&((t=user==null?void 0:user.last_tavern)==null?void 0:t.y)===(areaSelected==null?void 0:areaSelected.y))return user==null?void 0:user.last_tavern_fighter},[user==null?void 0:user.last_tavern,user==null?void 0:user.last_tavern_fighter,areaSelected==null?void 0:areaSelected.x,areaSelected==null?void 0:areaSelected.y]);return jsxRuntimeExports.jsxs(Wrapper,{children:[jsxRuntimeExports.jsxs(Header,{children:[!isRevealed&&jsxRuntimeExports.jsxs(Button,{disabled:isHireLoading,isLoading:isHireLoading,color:"black",onClick:handleHire,children:["Hire",jsxRuntimeExports.jsxs("span",{children:[hireCost,jsxRuntimeExports.jsx("img",{loading:"lazy",src:"/assets/icons/energy.png",alt:""})]})]}),!tavernFighter&&jsxRuntimeExports.jsxs(Button,{color:"black",isLoading:isRevealLoading,onClick:()=>{var e,t;return handleReveal((((e=user==null?void 0:user.activestats)==null?void 0:e.gems)||0)>=(((t=tavernConfig==null?void 0:tavernConfig[0])==null?void 0:t.cost_reveal_gem)||0))},disabled:showRevelCost()===null||isRevealLoading,children:["Reveal",jsxRuntimeExports.jsxs("span",{children:[showRevelCost(),jsxRuntimeExports.jsx("img",{loading:"lazy",src:"/assets/icons/credits.png",alt:""})]})]}),isSmall&&jsxRuntimeExports.jsxs(Button,{color:"black",onClick:()=>setIsFighterSelected(e=>!e),children:[isFighterSelected?"Hide":"Show"," Fighter"]}),jsxRuntimeExports.jsx(Button,{color:"black",onClick:handleLeaveArena,children:"Leave"})]}),jsxRuntimeExports.jsxs(ContentWrapper,{children:[jsxRuntimeExports.jsxs(Container,{isHidden:isFighterSelected&&isSmall,children:[jsxRuntimeExports.jsxs(CardContainer,{cardSelected:inventoryPosition,children:[jsxRuntimeExports.jsx(InventoryCard,{item:selectedCards[0],onClick:()=>handleInventoryPosition(0)}),jsxRuntimeExports.jsx(InventoryCard,{item:selectedCards[1],onClick:()=>handleInventoryPosition(1)}),jsxRuntimeExports.jsx(InventoryCard,{item:selectedCards[2],onClick:()=>handleInventoryPosition(2)})]}),jsxRuntimeExports.jsx(ObjectivesContainer,{areaSelected,selectedBonus,selectedFilter,setSelectedFilter}),jsxRuntimeExports.jsx(InventoryContainer,{selectedCards,inventoryPosition,isInventoryLoading,filteredInventory:filteredInventory.filter(filterInventoryCards),inventoryFilter,setInventoryFilter,handleSelectCard})]}),jsxRuntimeExports.jsx(FighterDetail,{isHidden:!isFighterSelected,selectedFighter:tavernFighter,onCloseFighterDetail:()=>handleReveal(),showCloseButton:!1})]})]})},index=React.memo(Tavern);export{index as default};
