import{s as W,g as U,S as p,v as J,e as w,u as y,q as X,R as k,_ as Z,a as z,r as b,j as r,Q as tt}from"./index-70e0b2df.js";import{u as ot,o as Q}from"./land-config-560c2063.js";import{o as q}from"./all-buildings-8771f7d2.js";import{u as I}from"./useQuery-7d8e5c8d.js";import{u as K}from"./use-transaction-0a64dc19.js";import{s as N}from"./sleep-da79c358.js";import{u as et}from"./index-3a8902c4.js";import{b as st}from"./constants-b95c644e.js";import"./atomic-api-6ce1afb7.js";import"./toast-options-37709a4b.js";const nt=W("div",{gridArea:"header",d:"flex",justifyContent:"flex-end",gap:"10px",minHeight:"65px",button:{padding:"20px",w:"100%",maxW:"100%","&.destroy":{borderColor:"#9E475D"},div:{d:"flex",alignItems:"center",gap:"5px",color:"#828282",img:{objectFit:"contain",w:"24px"}}},"@sm":{gap:"5px",button:{fs:"12px",padding:"10px",div:{img:{w:"20px"}}}}}),at=async t=>await U({options:{code:p.landsAle,index_position:1,limit:"1000",scope:t,table:J.buildingcost}}),it=t=>I({queryFn:()=>rt(t),queryKey:[w.buildingConfigState,t],staleTime:1e3*60*60,enabled:!!y.getState().user});async function H(t){return await X.invalidateQueries([w.buildingConfigState,t])}async function rt(t){try{return await at(t)}catch(e){return console.log(e),null}}async function ct(t,e){const{executeTransaction:s}=K(),d=lt(t,e);return!!await s(d)}function lt(t,e){return{actions:[{account:p.landsAle,name:"build",authorization:[{actor:t.name,permission:t.authorization.permission}],data:{wallet:t.name,planet:e.planet,x:e.x,y:e.y,building:e.building,level:e.level,cost_gem:e.cost_gem,cost_credits:e.cost_credits}}]}}async function ut(t,e){const{executeTransaction:s}=K(),d=dt(t,e);return!!await s(d)}function dt(t,e){return{actions:[{account:p.landsAle,name:"boost",authorization:[{actor:t.name,permission:t.authorization.permission}],data:{wallet:t.name,planet:e.planet,building:e.building,x:e.x,y:e.y,cost_gems:e.cost_gems,cost_credits:e.cost_credits,boost_target:e.boost_target}}]}}const gt=async()=>await U({options:{code:p.landsAle,index_position:1,limit:"1000",scope:p.landsAle,table:"raritydisc"}}),mt=()=>I({queryFn:()=>pt(),queryKey:[w.RarityDiscState],staleTime:1e3*60*60,enabled:!!y.getState().user});async function pt(){try{return await gt()}catch(t){return console.log(t),null}}const h=k.lazy(()=>Z(()=>import("./index-7ec3138c.js"),["assets/index-7ec3138c.js","assets/index-70e0b2df.js","assets/index-55fec1ff.css","assets/index-e97083aa.js"])),_t=()=>{var L,j,C;const{data:t}=ot(),{data:e}=mt(),s=y(z(a=>a.user)),d=y(z(a=>a.updateLandsData)),{selectedLand:n,setSelectedLand:O,buildingBoost:g,selectedBuild:o,setSelectedBuild:$,setIsDestroying:P}=et(),{data:_}=it((o==null?void 0:o.img)||""),[v,T]=b.useState(!1),[f,S]=b.useState(!1);async function Y(){var a;if(n)try{S(!0);const i=((a=s==null?void 0:s.activestats)==null?void 0:a.gems)>=m*10,l=i?m*10:0,u=i?0:m,x={planet:n.data.planetName,x:n.data.x,y:n.data.y,building:o.building_name.toLowerCase(),boost_target:g[0]*1e4,cost_gems:l,cost_credits:u};await ut(s,x)&&(await N(2e3),await d(),await Q(),await H(o.building_name.toLowerCase()),await q())}catch(i){console.error(i)}finally{S(!1)}}async function G(){if(!s){console.log("User not authenticated");return}if(!n||!o){console.log("Selected land or build is not available");return}if(!c){console.log("Building cost not available");return}if(!t||!t[0]){console.log("Land configuration not available");return}if(!g||g.length===0){console.log("Building boost not available");return}try{T(!0);const a={planet:n.data.planetName,x:n.data.x,y:n.data.y,building:o.building_name.toLowerCase(),level:o!=null&&o.boost_score?(o.level||1)+1:1,cost_gem:c.cost_gem||0,cost_credits:c.cost_credits};await ct(s,a)&&(await N(2e3),await Q(),await H(o==null?void 0:o.img),await q(),tt.success("Building constructed"))}catch(a){console.error(a)}finally{T(!1),O(null),$({...st[0]})}}const c=b.useMemo(()=>{const a=_==null?void 0:_.find(l=>l.building_name===o.img&&l.level===((o==null?void 0:o.level)||0)+1),i=e==null?void 0:e.find(l=>l.rarity.toLocaleLowerCase()===(n==null?void 0:n.data.rarity.toLocaleLowerCase()));return{...a,cost_credits:((a==null?void 0:a.cost_credits)||0)-((i==null?void 0:i.credits_building_discount)||0)}},[_,e,n==null?void 0:n.data.rarity,o]),m=b.useMemo(()=>{var D,E,F,M;const a=((D=t==null?void 0:t[0])==null?void 0:D.boost_base_cost)||0,i=((E=t==null?void 0:t[0])==null?void 0:E.boost_cost_first_percent)||0,l=(o==null?void 0:o.boost_score)||0,u=Number(((F=t==null?void 0:t[0])==null?void 0:F.boost_cost_mod)||0),x=(1-Math.pow(u,g[0]+1))/(1-u),A=(1-Math.pow(u,l/1e4+1))/(1-u),R=a+i*(x-A),B=(((M=t==null?void 0:t[0])==null?void 0:M.start_boost_score)||0)/1e4;return Math.round(R<B?B:R)},[g,t,o]),V=!!(o!=null&&o.boost_score_update);return r.jsx(nt,{children:n&&(V?r.jsxs(r.Fragment,{children:[r.jsx(h,{className:"destroy",isLoading:f,disabled:f,onClick:()=>P(!0),children:"Destroy Building"}),r.jsxs(h,{isLoading:f,disabled:f||m>Number(((L=s==null?void 0:s.activestats)==null?void 0:L.credits)||0),onClick:Y,children:["Boost"," ",r.jsxs("div",{children:[m.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}),r.jsx("img",{src:"/assets/icons/credits.png",alt:"credits",loading:"lazy"})," "]})]})]}):r.jsxs(h,{isLoading:v,disabled:v||((c==null?void 0:c.cost_credits)||0)>(((j=s==null?void 0:s.activestats)==null?void 0:j.credits)||0),onClick:G,children:["Build ",o==null?void 0:o.building_name,r.jsxs("div",{children:[(C=c==null?void 0:c.cost_credits)==null?void 0:C.toLocaleString("en-US")," ",r.jsx("img",{src:"/assets/icons/credits.png",alt:"credits",loading:"lazy"})]})]}))})},jt=k.memo(_t);export{jt as default};
