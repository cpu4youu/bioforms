import{s,g as B,S,q as I,u as k,e as W,R as E,_ as F,b as O,r as u,j as e}from"./index-c378eb06.js";import{u as P}from"./useQuery-4887d7e5.js";import{u as V,a as Y}from"./index-39e6d45a.js";import{v as M}from"./v4-4a60fe23.js";import"./index-1203e4d5.js";import"./index-7252f502.js";import"./use-media-6aaedb85.js";import"./sleep-da79c358.js";import"./use-transaction-3adaf42b.js";import"./toast-options-38216f5d.js";const K=s("div",{d:"grid",gridTemplateAreas:`
    "empty header"
    "main main"
  `,gridTemplateColumns:"3fr 1fr",gap:"10px",br:"15px",w:"100%",h:"100%"}),L=s("div",{gridArea:"header",d:"flex",justifyContent:"flex-end",gap:"10px",minHeight:"65px",button:{padding:"20px",w:"100%",maxW:"100%",div:{d:"flex",alignItems:"center",gap:"5px",color:"#828282",img:{objectFit:"contain",w:"24px"}}}}),U=s("div",{gridArea:"main",d:"flex",align:"flex-start",alignContent:"flex-start",justifyContent:"center",w:"100%",gap:"10px",flexWrap:"wrap",minH:"calc(100vh - 160px)",maxH:"calc(100vh - 160px)",overflowY:"auto",padding:"10px",br:"15px",bg:"#141423"}),X=s("div",{gridArea:"main",d:"flex",direction:"column",w:"100%",maxW:"1360px",h:"calc(100vh - 235px)",mx:"auto",px:"20px"}),N=s("h3",{textAlign:"center",w:"100%",fontSize:"16px",fontWeight:"bold",ff:"$heading",color:"#C9C9C9","@sm":{fontSize:"14px"}}),G=s("span",{textAlign:"center",w:"100%",fontSize:"16px",ff:"$heading",color:"#C9C9C9","@sm":{h:"initial",fontSize:"14px"}}),J=s("div",{d:"flex",justify:"space-between",align:"center",gap:"5px",mt:"35px",">span":{mx:"95px",color:"#fff",fw:"bold",ff:"$heading",fs:"12px"},"@lg":{mt:"10px",gap:"15px",direction:"column"}}),Z=s("div",{d:"flex",direction:"column",">span":{color:"#535353",fw:"bold",ff:"$heading",fs:"12px"},">div":{d:"flex",justify:"space-between",gap:"5px"}}),H=s("div",{d:"flex",direction:"column",">span":{color:"#535353",fw:"bold",ff:"$heading",fs:"12px"}}),ee=s("div",{d:"flex",justify:"space-between",gap:"5px"}),te=s("div",{d:"flex",justify:"space-between",gap:"5px",mt:"20px"}),ne=s("div",{mt:"20px",w:"100%","@sm":{mt:"5px",overflowX:"scroll"}}),ae=s("div",{d:"grid",gridTemplateColumns:"70px 70px 90px 90px 150px 150px 150px",w:"100%",bg:"#242438",padding:"8px",fontSize:"12px",fontWeight:"bold",ff:"$heading",color:"#C9C9C9",span:{d:"flex",align:"center",justify:"center",textAlign:"center"},"@xlg":{gridTemplateColumns:"70px 70px 70px 70px 100px 100px 100px"},"@md":{gap:"3px",fontSize:"12px"},"@sm":{padding:"2px",gridTemplateColumns:"50px 50px 50px 50px 60px 60px 60px",gap:"3px",fontSize:"10px",w:"calc(100vw )",span:{fontSize:"8px"}},"@xsm":{w:"calc(110vw)"}}),ie=s("div",{d:"flex",direction:"column",gap:"10px",pb:"20px",overflowY:"auto",h:"calc(100vh - 500px)",span:{d:"flex",align:"center",justify:"center",color:"#fff",fw:"bold",ff:"$heading",fs:"12px"},"@lg":{h:"calc(100vh - 500px)"},"@sm":{span:{fs:"8px"},w:"calc(100vw)",overflowX:"hidden"},"@xsm":{w:"calc(110vw)"}}),se=s("div",{d:"grid",gridTemplateColumns:"70px 70px 90px 90px 150px 150px 150px",bg:"#201D2C",padding:"8px",variants:{isSelected:{true:{bg:"rgb(255 255 255 / 17%)"}}},"@xlg":{gridTemplateColumns:"70px 70px 70px 70px 100px 100px 100px"},"@sm":{padding:"2px",gap:"3px",gridTemplateColumns:"50px 50px 50px 50px 60px 60px 60px",span:{textAlign:"center",fontSize:"8px"},">button":{w:"50px",h:"50px",">div":{img:{scale:"3.2",translate:"-5px 10px"}}}}});s("div",{d:"flex",justify:"center",align:"center",direction:"column",gap:"20px",mt:"40px",img:{height:235,width:235,objectFit:"contain"}});s("div",{textAlign:"center",w:"100%",fontSize:"16px",fontWeight:"bold",ff:"$heading",color:"#C9C9C9","@sm":{fontSize:"14px"}});s("div",{d:"flex",justify:"center",align:"center",width:"23%"});s("div",{d:"flex",justify:"center",align:"center",direction:"column",textAlign:"center",w:"100%",fontSize:"16px",fontWeight:"bold",ff:"$heading",color:"#C9C9C9",img:{height:80,width:80,objectFit:"contain"}});s("div",{textAlign:"center",w:"100%",fontSize:"16px",fontWeight:"bold",ff:"$heading",color:"#C9C9C9","@sm":{fontSize:"14px"}});const re=async r=>await B({options:{code:S.battleAle,index_position:1,limit:"1000",lower_bound:r,upper_bound:r,scope:S.battleAle,table:I.history}}),le=r=>P({enabled:!!k.getState().user,queryKey:[W.HistoryDataState,r],queryFn:()=>ce(r),staleTime:1e3*60*20});async function ce(r){try{const o=await re(r);if(!o)return null;const g=o==null?void 0:o.find(l=>l.history_id===r);return g?{...g,team1_fighters:g.team1_fighters.filter(l=>typeof l.fighter_id=="number")}:null}catch(o){return console.log(o),null}}const oe=async r=>await B({options:{code:S.poolsAle,index_position:2,key_type:"i64",limit:"1000",reverse:!0,lower_bound:r,upper_bound:r,scope:S.poolsAle,table:"minehistory"}}),de=()=>P({enabled:!!k.getState().user,queryKey:[W.dungeonPoolDataState],queryFn:()=>pe(),staleTime:1e3*60*20});async function pe(){const r=k.getState().user;try{const o=await oe(r==null?void 0:r.name);return o!=null&&o[0]?o[0]:null}catch(o){return console.log(o),null}}function xe(r,o){const g=[...r.map(l=>({...l,team:1})),...o.map(l=>({...l,team:2}))],_=[];for(;g.filter(l=>l.team===1&&l.health>0).length>0&&g.filter(l=>l.team===2&&l.health>0).length>0;){const l=g.filter(d=>d.health>0),x=l.reduce((d,m)=>m.initiative<d.initiative?m:d),T=x.team===1?2:1,v=l.filter(d=>d.team===T);if(v.length===0)return;const a=v.reduce((d,m)=>m.taunt>d.taunt?m:d),t=`res_${x.element}`,C=a[t]/10,i=x.damage*(100-C)/100,b=i*100/x.damage;_.push({attacker:x,defender:a,attack:i,attackerHealthBefore:x.health,attackerTeam:x.team,defenderTeam:a.team,defenderTauntBefore:a.taunt,defenderHealthBefore:a.health,effectiveness:b}),a.health-=i,a.taunt=Math.max(0,a.taunt-10),x.initiative+=x.attackspeed}return _}const D=E.lazy(()=>F(()=>import("./index-b2bdc562.js"),["assets/index-b2bdc562.js","assets/index-c378eb06.js","assets/index-55fec1ff.css"])),w=E.lazy(()=>F(()=>import("./index-e04f5619.js"),["assets/index-e04f5619.js","assets/index-c378eb06.js","assets/index-55fec1ff.css","assets/iconBase-e82222fa.js"])),fe=E.lazy(()=>F(()=>import("./index-2b553b09.js"),["assets/index-2b553b09.js","assets/index-c378eb06.js","assets/index-55fec1ff.css","assets/assets-id-query-d80561a0.js","assets/useQuery-4887d7e5.js","assets/adapters-14c1a4ab.js","assets/atomic-api-929dd3e6.js","assets/toast-options-38216f5d.js"])),Se=({historyId:r})=>{const{areaSelected:o,setAreaSelected:g}=O(),{data:_}=le(r),{data:l}=de(),{data:x}=V(),{data:T}=Y(),v=u.useRef(null),[a,$]=u.useState(),[t,C]=u.useState([]),[i,b]=u.useState(0),[d,m]=u.useState({}),A=u.useMemo(()=>x==null?void 0:x.find(n=>n.weather_id===(T==null?void 0:T.current_weather_id)),[x,T]);function Q(){g(null)}function q(){b(t.length-1);const n={};t.forEach(p=>{n[`${p.defender.fighter_id}-${p.defenderTeam}`]=p.defender.health}),m(n)}u.useEffect(()=>{$(_??void 0)},[_]),u.useEffect(()=>{if(a!=null&&a.team1_fighters&&(a!=null&&a.team2_fighters)){const n=a.team1_fighters.map(h=>({...h,team:1})),p=a.team2_fighters.map(h=>({...h,team:2})),c={};[...n,...p].forEach(h=>{c[`${h.fighter_id}-${h.team}`]=h.health}),m(c);const j=xe(n,p);C(j||[]),b(0)}},[a,o]),u.useEffect(()=>{if(t.length===0||i>=t.length)return;const n=setTimeout(()=>{var h,z,R;const p=(h=t==null?void 0:t[i])==null?void 0:h.attack,c=(z=t==null?void 0:t[i])==null?void 0:z.defender,f=(R=t==null?void 0:t[i])==null?void 0:R.defenderTeam;d[`${c==null?void 0:c.fighter_id}-${f}`]!==void 0&&m({...d,[`${c==null?void 0:c.fighter_id}-${f}`]:Math.max(0,d[`${c==null?void 0:c.fighter_id}-${f}`]-p)});const j=i+1;b(j)},1e3);return()=>clearTimeout(n)},[t,i,d]),u.useEffect(()=>{v.current&&(v.current.scrollTop=v.current.scrollHeight)},[i]);const y=i>=t.length-1;return e.jsxs(K,{children:[e.jsx(L,{children:y?e.jsx(D,{onClick:Q,children:"Back"}):e.jsx(D,{onClick:q,children:"Skip Fight"})}),e.jsx(U,{children:y?e.jsx(fe,{data:_,pool:l,healthMap:d}):e.jsxs(e.Fragment,{children:[e.jsx(N,{children:"Weather"}),e.jsx(G,{children:A==null?void 0:A.displayname}),e.jsxs(X,{children:[e.jsxs(J,{children:[e.jsxs(Z,{children:[e.jsx("span",{children:"YOUR TEAM"}),e.jsx("div",{children:a==null?void 0:a.team1_fighters.map(n=>{var p,c,f,j;return e.jsx(w,{isFighting:!0,isAttacking:((p=t==null?void 0:t[i])==null?void 0:p.attackerTeam)===1&&((c=t==null?void 0:t[i])==null?void 0:c.attacker.fighter_id)===n.fighter_id,isDefending:((f=t==null?void 0:t[i])==null?void 0:f.defenderTeam)===1&&((j=t==null?void 0:t[i])==null?void 0:j.defender.fighter_id)===n.fighter_id,fighter:{...n,stats:{...n,health:d[`${n.fighter_id}-1`]}}},M())})})]}),e.jsx("span",{children:"VS"}),e.jsx(ee,{children:a==null?void 0:a.team2_fighters.map(n=>{var p,c,f,j;return e.jsxs(H,{children:[e.jsx("span",{children:"AI"}),e.jsx(w,{isFighting:!0,isAttacking:((p=t==null?void 0:t[i])==null?void 0:p.attackerTeam)===2&&((c=t==null?void 0:t[i])==null?void 0:c.attacker.fighter_id)===n.fighter_id,isDefending:((f=t==null?void 0:t[i])==null?void 0:f.defenderTeam)===2&&((j=t==null?void 0:t[i])==null?void 0:j.defender.fighter_id)===n.fighter_id,fighter:{...n,stats:{...n,health:d[`${n.fighter_id}-2`]}}})]},M())})})]}),e.jsx(te,{children:e.jsxs(ne,{children:[e.jsxs(ae,{children:[e.jsx("span",{children:"Attacker"}),e.jsx("span",{children:"Defender"}),e.jsx("span",{children:"Attack"}),e.jsx("span",{children:"Damage"}),e.jsx("span",{children:"Remaining Health"}),e.jsx("span",{children:"Effectiveness"}),e.jsx("span",{children:"Special Event"})]}),e.jsx(ie,{ref:v,children:t.slice(0,i).map((n,p)=>e.jsxs(se,{children:[e.jsx(w,{isFighting:!0,fighter:{...n.attacker,stats:{...n.attacker,health:n.attackerHealthBefore}}}),e.jsx(w,{isFighting:!0,fighter:{...n.defender,stats:{...n.defender,health:n.defenderHealthBefore-n.attack}}}),e.jsx("span",{children:n.attack.toFixed(2)}),e.jsx("span",{children:n.attacker.damage.toFixed(2)}),e.jsx("span",{children:(n.defenderHealthBefore-n.attack).toFixed(2)}),e.jsxs("span",{children:[n.effectiveness.toFixed(2),"%"]}),e.jsx("span",{children:"-"}),e.jsxs("span",{children:["ID: ",n.attacker.fighter_id,e.jsx("br",{}),"TEAM: ",n.attackerTeam," "]}),e.jsxs("span",{children:["ID: ",n.defender.fighter_id,e.jsx("br",{}),"TEAM: ",n.defenderTeam]})]},p))})]})})]})]})})]})};export{Se as default};
