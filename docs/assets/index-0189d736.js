import{s as k,g as I,S as b,q as K,e as q,u as F,w as O,R as H,_ as P,a as Y,r as d,j as c}from"./index-41d3dae2.js";import{o as M,a as E}from"./all-buildings-53abaf63.js";import{u as D}from"./useQuery-5922338e.js";import{u as G}from"./land-config-4e8303a0.js";import{u as N}from"./use-transaction-3c62e870.js";import{s as z}from"./sleep-da79c358.js";import{u as V}from"./index-30d20751.js";import"./atomic-api-2adf8789.js";import"./toast-options-85dc2973.js";import"./constants-da06ccb0.js";const W=k("div",{gridArea:"header",d:"flex",justifyContent:"flex-end",gap:"10px",minHeight:"65px",button:{padding:"20px",w:"100%",maxW:"100%",div:{d:"flex",alignItems:"center",gap:"5px",color:"#828282",img:{objectFit:"contain",w:"24px"}}},"@sm":{gap:"5px",button:{fs:"12px",padding:"10px",div:{img:{w:"20px"}}}}}),J=async t=>await I({options:{code:b.landsAle,index_position:1,limit:"1000",scope:t,table:K.buildingcost}}),X=t=>D({queryFn:()=>Z(t),queryKey:[q.buildingConfigState,t],staleTime:1e3*60*60,enabled:!!F.getState().user});async function B(t){return await O.invalidateQueries([q.buildingConfigState,t])}async function Z(t){try{return await J(t)}catch(n){return console.log(n),null}}async function tt(t,n){const{executeTransaction:e}=N(),u=ot(t,n);return!!await e(u)}function ot(t,n){return{actions:[{account:b.landsAle,name:"build",authorization:[{actor:t.name,permission:t.authorization.permission}],data:{wallet:t.name,planet:n.planet,x:n.x,y:n.y,building:n.building,level:n.level,cost_gem:n.cost_gem,cost_credits:n.cost_credits}}]}}async function nt(t,n){const{executeTransaction:e}=N(),u=et(t,n);return!!await e(u)}function et(t,n){return{actions:[{account:b.landsAle,name:"boost",authorization:[{actor:t.name,permission:t.authorization.permission}],data:{wallet:t.name,planet:n.planet,building:n.building,x:n.x,y:n.y,cost_gems:n.cost_gems,cost_credits:n.cost_credits,boost_target:n.boost_target}}]}}const Q=H.lazy(()=>P(()=>import("./index-6a2fce6d.js"),["assets/index-6a2fce6d.js","assets/index-41d3dae2.js","assets/index-55fec1ff.css"])),st=()=>{var v;const{data:t}=G(),n=F(Y(s=>s.user)),{selectedLand:e,setSelectedLand:u,buildingBoost:a,selectedBuild:o}=V(),{data:g}=X(o.img),[f,x]=d.useState(!1),[y,h]=d.useState(!1);async function U(){var s;if(e)try{h(!0);const r=((s=n==null?void 0:n.activestats)==null?void 0:s.gems)>=m*10,p=r?m*10:0,l=r?0:m,_={planet:e.data.planetName,x:e.data.x,y:e.data.y,building:o.building_name.toLowerCase(),boost_target:a[0],cost_gems:p,cost_credits:l};await nt(n,_)&&(await z(1e3),await M(),await B(o.building_name.toLowerCase()),await E())}catch(r){console.error(r)}finally{h(!1)}}async function $(){if(!n){console.log("User not authenticated");return}if(!e||!o){console.log("Selected land or build is not available");return}if(!i){console.log("Building cost not available");return}if(!t||!t[0]){console.log("Land configuration not available");return}if(!a||a.length===0){console.log("Building boost not available");return}try{x(!0);const s={planet:e.data.planetName,x:e.data.x,y:e.data.y,building:o.building_name.toLowerCase(),level:o!=null&&o.boost_score?(o.level||1)+1:1,cost_gem:i.cost_gem,cost_credits:i.cost_credits};await tt(n,s)&&(await z(2e3),await M(),await B(o==null?void 0:o.img),await E())}catch(s){console.error(s)}finally{x(!1),u(null)}}const i=d.useMemo(()=>g==null?void 0:g.find(s=>s.building_name===o.img&&s.level===((o==null?void 0:o.level)||0)+1),[g,o]),m=d.useMemo(()=>{var C,j,A,R;const s=((C=t==null?void 0:t[0])==null?void 0:C.boost_base_cost)||0,r=((j=t==null?void 0:t[0])==null?void 0:j.boost_cost_first_percent)||0,p=(o==null?void 0:o.boost_score)||0,l=Number(((A=t==null?void 0:t[0])==null?void 0:A.boost_cost_mod)||0),_=(1-Math.pow(l,a[0]+1))/(1-l),T=(1-Math.pow(l,p/1e4+1))/(1-l),L=s+r*(_-T),S=(((R=t==null?void 0:t[0])==null?void 0:R.start_boost_score)||0)/1e4;return Math.round(L<S?S:L)},[a,t,o]),w=!!(o!=null&&o.boost_score);return c.jsxs(W,{children:[e&&w&&c.jsxs(Q,{isLoading:y,disabled:y,onClick:U,children:["Boost"," ",c.jsxs("div",{children:[m.toFixed(2),c.jsx("img",{src:"/assets/icons/gems.png",alt:"Land"})," "]})]}),e&&!!i&&c.jsxs(Q,{isLoading:f,disabled:f,onClick:$,children:[w?`Upgrade ${o==null?void 0:o.building_name}`:`Build ${o==null?void 0:o.building_name}`,c.jsxs("div",{children:[(v=i==null?void 0:i.cost_gem)==null?void 0:v.toLocaleString("en-US")," ",c.jsx("img",{src:"/assets/icons/gems.png",alt:"Land"})]})]})]})},_t=H.memo(st);export{_t as default};
