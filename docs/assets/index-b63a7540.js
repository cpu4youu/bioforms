import{s as k,g as I,S as b,q as K,e as q,u as F,w as P,R as H,_ as Y,a as D,r as d,j as c}from"./index-c378eb06.js";import{o as M,a as E}from"./all-buildings-354bd669.js";import{u as G}from"./useQuery-4887d7e5.js";import{u as V}from"./land-config-b4d633f6.js";import{u as N}from"./use-transaction-3adaf42b.js";import{s as z}from"./sleep-da79c358.js";import{u as W}from"./index-bd414545.js";import{b as J}from"./constants-9b21425a.js";import"./atomic-api-929dd3e6.js";import"./toast-options-38216f5d.js";const X=k("div",{gridArea:"header",d:"flex",justifyContent:"flex-end",gap:"10px",minHeight:"65px",button:{padding:"20px",w:"100%",maxW:"100%",div:{d:"flex",alignItems:"center",gap:"5px",color:"#828282",img:{objectFit:"contain",w:"24px"}}},"@sm":{gap:"5px",button:{fs:"12px",padding:"10px",div:{img:{w:"20px"}}}}}),Z=async t=>await I({options:{code:b.landsAle,index_position:1,limit:"1000",scope:t,table:K.buildingcost}}),tt=t=>G({queryFn:()=>ot(t),queryKey:[q.buildingConfigState,t],staleTime:1e3*60*60,enabled:!!F.getState().user});async function B(t){return await P.invalidateQueries([q.buildingConfigState,t])}async function ot(t){try{return await Z(t)}catch(n){return console.log(n),null}}async function nt(t,n){const{executeTransaction:e}=N(),u=et(t,n);return!!await e(u)}function et(t,n){return{actions:[{account:b.landsAle,name:"build",authorization:[{actor:t.name,permission:t.authorization.permission}],data:{wallet:t.name,planet:n.planet,x:n.x,y:n.y,building:n.building,level:n.level,cost_gem:n.cost_gem,cost_credits:n.cost_credits}}]}}async function st(t,n){const{executeTransaction:e}=N(),u=at(t,n);return!!await e(u)}function at(t,n){return{actions:[{account:b.landsAle,name:"boost",authorization:[{actor:t.name,permission:t.authorization.permission}],data:{wallet:t.name,planet:n.planet,building:n.building,x:n.x,y:n.y,cost_gems:n.cost_gems,cost_credits:n.cost_credits,boost_target:n.boost_target}}]}}const Q=H.lazy(()=>Y(()=>import("./index-b2bdc562.js"),["assets/index-b2bdc562.js","assets/index-c378eb06.js","assets/index-55fec1ff.css"])),it=()=>{var v;const{data:t}=V(),n=F(D(s=>s.user)),{selectedLand:e,setSelectedLand:u,buildingBoost:a,selectedBuild:o,setSelectedBuild:U}=W(),{data:g}=tt((o==null?void 0:o.building_name)||""),[f,x]=d.useState(!1),[y,h]=d.useState(!1);async function $(){var s;if(e)try{h(!0);const r=((s=n==null?void 0:n.activestats)==null?void 0:s.gems)>=m*10,p=r?m*10:0,l=r?0:m,_={planet:e.data.planetName,x:e.data.x,y:e.data.y,building:o.building_name.toLowerCase(),boost_target:a[0],cost_gems:p,cost_credits:l};await st(n,_)&&(await z(1e3),await M(),await B(o.building_name.toLowerCase()),await E())}catch(r){console.error(r)}finally{h(!1)}}async function O(){if(!n){console.log("User not authenticated");return}if(!e||!o){console.log("Selected land or build is not available");return}if(!i){console.log("Building cost not available");return}if(!t||!t[0]){console.log("Land configuration not available");return}if(!a||a.length===0){console.log("Building boost not available");return}try{x(!0);const s={planet:e.data.planetName,x:e.data.x,y:e.data.y,building:o.building_name.toLowerCase(),level:o!=null&&o.boost_score?(o.level||1)+1:1,cost_gem:i.cost_gem,cost_credits:i.cost_credits};await nt(n,s)&&(await z(2e3),await M(),await B(o==null?void 0:o.img),await E())}catch(s){console.error(s)}finally{x(!1),u(null),U({...J[0]})}}const i=d.useMemo(()=>g==null?void 0:g.find(s=>s.building_name===o.building_name&&s.level===((o==null?void 0:o.level)||0)+1),[g,o]),m=d.useMemo(()=>{var C,j,A,R;const s=((C=t==null?void 0:t[0])==null?void 0:C.boost_base_cost)||0,r=((j=t==null?void 0:t[0])==null?void 0:j.boost_cost_first_percent)||0,p=(o==null?void 0:o.boost_score)||0,l=Number(((A=t==null?void 0:t[0])==null?void 0:A.boost_cost_mod)||0),_=(1-Math.pow(l,a[0]+1))/(1-l),T=(1-Math.pow(l,p/1e4+1))/(1-l),L=s+r*(_-T),S=(((R=t==null?void 0:t[0])==null?void 0:R.start_boost_score)||0)/1e4;return Math.round(L<S?S:L)},[a,t,o]),w=!!(o!=null&&o.boost_score);return c.jsxs(X,{children:[e&&w&&c.jsxs(Q,{isLoading:y,disabled:y,onClick:$,children:["Boost"," ",c.jsxs("div",{children:[m.toFixed(2),c.jsx("img",{src:"/assets/icons/gems.png",alt:"Land"})," "]})]}),e&&!!i&&c.jsxs(Q,{isLoading:f,disabled:f,onClick:O,children:[w?`Upgrade ${o==null?void 0:o.building_name}`:`Build ${o==null?void 0:o.building_name}`,c.jsxs("div",{children:[(v=i==null?void 0:i.cost_gem)==null?void 0:v.toLocaleString("en-US")," ",c.jsx("img",{src:"/assets/icons/gems.png",alt:"Land"})]})]})]})},ft=H.memo(it);export{ft as default};
