import{s as G,g as H,S as m,v as V,e as h,u as w,q as W,R as U,_ as J,a as X,r as f,j as r,Q as Z}from"./index-d5c19f07.js";import{u as tt,o as D}from"./land-config-178c063e.js";import{o as Q}from"./all-buildings-e076dce1.js";import{u as k}from"./useQuery-e16c299d.js";import{u as I}from"./use-transaction-52d187eb.js";import{s as q}from"./sleep-da79c358.js";import{u as ot}from"./index-bcaa2a9b.js";import{b as et}from"./constants-b95c644e.js";import"./atomic-api-0a136ba2.js";import"./toast-options-c7a995a7.js";const st=G("div",{gridArea:"header",d:"flex",justifyContent:"flex-end",gap:"10px",minHeight:"65px",button:{padding:"20px",w:"100%",maxW:"100%","&.destroy":{borderColor:"#9E475D"},div:{d:"flex",alignItems:"center",gap:"5px",color:"#828282",img:{objectFit:"contain",w:"24px"}}},"@sm":{gap:"5px",button:{fs:"12px",padding:"10px",div:{img:{w:"20px"}}}}}),nt=async t=>await H({options:{code:m.landsAle,index_position:1,limit:"1000",scope:t,table:V.buildingcost}}),at=t=>k({queryFn:()=>it(t),queryKey:[h.buildingConfigState,t],staleTime:1e3*60*60,enabled:!!w.getState().user});async function N(t){return await W.invalidateQueries([h.buildingConfigState,t])}async function it(t){try{return await nt(t)}catch(e){return console.log(e),null}}async function rt(t,e){const{executeTransaction:n}=I(),s=ct(t,e);return!!await n(s)}function ct(t,e){return{actions:[{account:m.landsAle,name:"build",authorization:[{actor:t.name,permission:t.authorization.permission}],data:{wallet:t.name,planet:e.planet,x:e.x,y:e.y,building:e.building,level:e.level,cost_gem:e.cost_gem,cost_credits:e.cost_credits}}]}}async function lt(t,e){const{executeTransaction:n}=I(),s=ut(t,e);return!!await n(s)}function ut(t,e){return{actions:[{account:m.landsAle,name:"boost",authorization:[{actor:t.name,permission:t.authorization.permission}],data:{wallet:t.name,planet:e.planet,building:e.building,x:e.x,y:e.y,cost_gems:e.cost_gems,cost_credits:e.cost_credits,boost_target:e.boost_target}}]}}const dt=async()=>await H({options:{code:m.landsAle,index_position:1,limit:"1000",scope:m.landsAle,table:"raritydisc"}}),gt=()=>k({queryFn:()=>mt(),queryKey:[h.RarityDiscState],staleTime:1e3*60*60,enabled:!!w.getState().user});async function mt(){try{return await dt()}catch(t){return console.log(t),null}}const x=U.lazy(()=>J(()=>import("./index-64e78562.js"),["assets/index-64e78562.js","assets/index-d5c19f07.js","assets/index-55fec1ff.css","assets/index-ff689e21.js"])),pt=()=>{var L,j,C;const{data:t}=tt(),{data:e}=gt(),n=w(X(a=>a.user)),{selectedLand:s,setSelectedLand:b,buildingBoost:d,selectedBuild:o,setSelectedBuild:K,setIsDestroying:O}=ot(),{data:p}=at((o==null?void 0:o.img)||""),[v,T]=f.useState(!1),[_,S]=f.useState(!1);async function $(){var a;if(s)try{S(!0);const i=((a=n==null?void 0:n.activestats)==null?void 0:a.gems)>=g*10,l=i?g*10:0,u=i?0:g,y={planet:s.data.planetName,x:s.data.x,y:s.data.y,building:o.building_name.toLowerCase(),boost_target:d[0]*1e4,cost_gems:l,cost_credits:u};await lt(n,y)&&(await q(1e3),await D(),await N(o.building_name.toLowerCase()),await Q())}catch(i){console.error(i)}finally{S(!1)}}async function P(){if(!n){console.log("User not authenticated");return}if(!s||!o){console.log("Selected land or build is not available");return}if(!c){console.log("Building cost not available");return}if(!t||!t[0]){console.log("Land configuration not available");return}if(!d||d.length===0){console.log("Building boost not available");return}try{T(!0);const a={planet:s.data.planetName,x:s.data.x,y:s.data.y,building:o.building_name.toLowerCase(),level:o!=null&&o.boost_score?(o.level||1)+1:1,cost_gem:c.cost_gem||0,cost_credits:c.cost_credits};await rt(n,a)&&(await q(2e3),await D(),await N(o==null?void 0:o.img),await Q(),Z.success("Building constructed"))}catch(a){console.error(a)}finally{T(!1),b(null),K({...et[0]})}}const c=f.useMemo(()=>{const a=p==null?void 0:p.find(l=>l.building_name===o.img&&l.level===((o==null?void 0:o.level)||0)+1),i=e==null?void 0:e.find(l=>l.rarity.toLocaleLowerCase()===(s==null?void 0:s.data.rarity.toLocaleLowerCase()));return{...a,cost_credits:((a==null?void 0:a.cost_credits)||0)-((i==null?void 0:i.credits_building_discount)||0)}},[p,e,s==null?void 0:s.data.rarity,o]),g=f.useMemo(()=>{var E,F,M,z;const a=((E=t==null?void 0:t[0])==null?void 0:E.boost_base_cost)||0,i=((F=t==null?void 0:t[0])==null?void 0:F.boost_cost_first_percent)||0,l=(o==null?void 0:o.boost_score)||0,u=Number(((M=t==null?void 0:t[0])==null?void 0:M.boost_cost_mod)||0),y=(1-Math.pow(u,d[0]+1))/(1-u),A=(1-Math.pow(u,l/1e4+1))/(1-u),R=a+i*(y-A),B=(((z=t==null?void 0:t[0])==null?void 0:z.start_boost_score)||0)/1e4;return Math.round(R<B?B:R)},[d,t,o]),Y=!!(o!=null&&o.boost_score_update);return r.jsx(st,{children:s&&(Y?r.jsxs(r.Fragment,{children:[r.jsx(x,{className:"destroy",isLoading:_,disabled:_,onClick:()=>O(!0),children:"Destroy Building"}),r.jsxs(x,{isLoading:_,disabled:_||g>Number(((L=n==null?void 0:n.activestats)==null?void 0:L.credits)||0),onClick:$,children:["Boost"," ",r.jsxs("div",{children:[g.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}),r.jsx("img",{src:"/assets/icons/credits.png",alt:"credits",loading:"lazy"})," "]})]})]}):r.jsxs(x,{isLoading:v,disabled:v||((c==null?void 0:c.cost_credits)||0)>(((j=n==null?void 0:n.activestats)==null?void 0:j.credits)||0),onClick:P,children:["Build ",o==null?void 0:o.building_name,r.jsxs("div",{children:[(C=c==null?void 0:c.cost_credits)==null?void 0:C.toLocaleString("en-US")," ",r.jsx("img",{src:"/assets/icons/credits.png",alt:"credits",loading:"lazy"})]})]}))})},Lt=U.memo(pt);export{Lt as default};
