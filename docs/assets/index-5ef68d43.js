import{s as i,g as B,S as b,t as q,u as k,e as D,R as M,_ as W,b as I,r as u,j as e}from"./index-ed29018d.js";import{u as P}from"./useQuery-c5560bf9.js";import{u as K,a as L}from"./index-e9a33250.js";import{v as F}from"./v4-4a60fe23.js";import"./index-f4b60224.js";import"./index-c586c3c1.js";import"./use-media-6a8f17ca.js";import"./sleep-da79c358.js";import"./use-transaction-2c18a958.js";import"./toast-options-ed070a73.js";const O=i("div",{d:"grid",gridTemplateAreas:`
    "empty header"
    "main main"
  `,gridTemplateColumns:"3fr 1fr",gap:"10px",br:"15px",w:"100%",h:"100%"}),V=i("div",{gridArea:"header",d:"flex",justifyContent:"flex-end",gap:"10px",minHeight:"65px",button:{padding:"20px",w:"100%",maxW:"100%",div:{d:"flex",alignItems:"center",gap:"5px",color:"#828282",img:{objectFit:"contain",w:"24px"}}}}),U=i("div",{gridArea:"main",d:"flex",align:"flex-start",alignContent:"flex-start",justify:"flex-center",justifyContent:"flex-center",w:"100%",gap:"10px",flexWrap:"wrap",minH:"calc(100vh - 175px)",overflowY:"auto",padding:"10px",br:"15px",bg:"#141423"}),X=i("div",{gridArea:"main",d:"flex",direction:"column",w:"100%",maxW:"1360px",h:"calc(100vh - 235px)",mx:"auto",px:"20px"}),N=i("h3",{textAlign:"center",w:"100%",fontSize:"16px",fontWeight:"bold",ff:"$heading",color:"#C9C9C9","@sm":{fontSize:"14px"}}),G=i("span",{textAlign:"center",w:"100%",fontSize:"16px",ff:"$heading",color:"#C9C9C9","@sm":{h:"initial",fontSize:"14px"}}),J=i("div",{d:"flex",justify:"space-between",align:"center",gap:"5px",mt:"35px",">span":{mx:"95px",color:"#fff",fw:"bold",ff:"$heading",fs:"12px"},"@lg":{mt:"10px",gap:"15px",direction:"column"}}),Z=i("div",{d:"flex",direction:"column",">span":{color:"#535353",fw:"bold",ff:"$heading",fs:"12px"},">div":{d:"flex",justify:"space-between",gap:"5px"}}),H=i("div",{d:"flex",direction:"column",">span":{color:"#535353",fw:"bold",ff:"$heading",fs:"12px"}}),ee=i("div",{d:"flex",justify:"space-between",gap:"5px"}),te=i("div",{d:"flex",justify:"space-between",gap:"5px",mt:"20px"}),ne=i("div",{mt:"20px",w:"100%","@sm":{mt:"5px",overflowX:"scroll"}}),ae=i("div",{d:"grid",gridTemplateColumns:"70px 70px 90px 90px 150px 150px 150px",w:"100%",bg:"#242438",padding:"8px",fontSize:"12px",fontWeight:"bold",ff:"$heading",color:"#C9C9C9",span:{d:"flex",align:"center",justify:"center",textAlign:"center"},"@xlg":{gridTemplateColumns:"70px 70px 70px 70px 100px 100px 100px"},"@md":{gap:"3px",fontSize:"12px"},"@sm":{padding:"2px",gridTemplateColumns:"50px 50px 50px 50px 60px 60px 60px",gap:"3px",fontSize:"10px",w:"calc(100vw )",span:{fontSize:"8px"}},"@xsm":{w:"calc(110vw)"}}),se=i("div",{d:"flex",direction:"column",gap:"10px",pb:"20px",overflowY:"auto",h:"calc(100vh - 500px)",span:{d:"flex",align:"center",justify:"center",color:"#fff",fw:"bold",ff:"$heading",fs:"12px"},"@lg":{h:"calc(100vh - 500px)"},"@sm":{span:{fs:"8px"},w:"calc(100vw)",overflowX:"hidden"},"@xsm":{w:"calc(110vw)"}}),ie=i("div",{d:"grid",gridTemplateColumns:"70px 70px 90px 90px 150px 150px 150px",bg:"#201D2C",padding:"8px",variants:{isSelected:{true:{bg:"rgb(255 255 255 / 17%)"}}},"@xlg":{gridTemplateColumns:"70px 70px 70px 70px 100px 100px 100px"},"@sm":{padding:"2px",gap:"3px",gridTemplateColumns:"50px 50px 50px 50px 60px 60px 60px",span:{textAlign:"center",fontSize:"8px"},">button":{w:"50px",h:"50px",">div":{img:{scale:"3.2",translate:"-5px 10px"}}}}}),re=i("div",{d:"flex",justify:"center",align:"center",direction:"column",gap:"20px",mt:"40px",img:{height:235,width:235,objectFit:"contain"}}),le=i("div",{textAlign:"center",w:"100%",fontSize:"16px",fontWeight:"bold",ff:"$heading",color:"#C9C9C9","@sm":{fontSize:"14px"}}),ce=i("div",{d:"flex",justify:"center",align:"center",width:"23%"}),z=i("div",{d:"flex",justify:"center",align:"center",direction:"column",textAlign:"center",w:"100%",fontSize:"16px",fontWeight:"bold",ff:"$heading",color:"#C9C9C9",img:{height:80,width:80,objectFit:"contain"}}),oe=i("div",{textAlign:"center",w:"100%",fontSize:"16px",fontWeight:"bold",ff:"$heading",color:"#C9C9C9","@sm":{fontSize:"14px"}}),de=async l=>await B({options:{code:b.battleAle,index_position:1,limit:"1000",lower_bound:l,upper_bound:l,scope:b.battleAle,table:q.history}}),pe=l=>P({enabled:!!k.getState().user,queryKey:[D.HistoryDataState,l],queryFn:()=>xe(l),staleTime:1e3*60*20});async function xe(l){try{const o=await de(l);return o!=null&&o[0]?o[0]:null}catch(o){return console.log(o),null}}const fe=async l=>await B({options:{code:b.poolsAle,index_position:2,key_type:"i64",limit:"1000",reverse:!0,lower_bound:l,upper_bound:l,scope:b.poolsAle,table:"minehistory"}}),he=()=>P({enabled:!!k.getState().user,queryKey:[D.dungeonPoolDataState],queryFn:()=>ge(),staleTime:1e3*60*20});async function ge(){const l=k.getState().user;try{const o=await fe(l==null?void 0:l.name);return o!=null&&o[0]?o[0]:null}catch(o){return console.log(o),null}}function ue(l,o){const v=[...l.map(r=>({...r,team:1})),...o.map(r=>({...r,team:2}))],d=[];for(;v.filter(r=>r.team===1&&r.stats.health>0).length>0&&v.filter(r=>r.team===2&&r.stats.health>0).length>0;){const r=v.filter(x=>x.stats.health>0),h=r.reduce((x,m)=>m.stats.initiative<x.stats.initiative?m:x),_=h.team===1?2:1,j=r.filter(x=>x.team===_);if(j.length===0)return;const a=j.reduce((x,m)=>m.stats.taunt>x.stats.taunt?m:x),t=`res_${h.element}`,S=a.stats[t],s=h.stats.damage*(100-S)/100,T=s*100/h.stats.damage;d.push({attacker:h,defender:a,attack:s,attackerHealthBefore:h.stats.health,attackerTeam:h.team,defenderTeam:a.team,defenderTauntBefore:a.stats.taunt,defenderHealthBefore:a.stats.health,effectiveness:T}),a.stats.health-=s,a.stats.taunt=Math.max(0,a.stats.taunt-10),h.stats.initiative+=h.stats.attackspeed}return d}const R=M.lazy(()=>W(()=>import("./index-1a9f0b22.js"),["assets/index-1a9f0b22.js","assets/index-ed29018d.js","assets/index-55fec1ff.css"])),w=M.lazy(()=>W(()=>import("./index-4f9d22c4.js"),["assets/index-4f9d22c4.js","assets/index-ed29018d.js","assets/index-55fec1ff.css","assets/iconBase-2e781021.js"])),Ae=({historyId:l})=>{const{areaSelected:o,setAreaSelected:v}=I(),{data:d}=pe(l),{data:r}=he(),{data:h}=K(),{data:_}=L(),j=u.useRef(null),[a,A]=u.useState(),[t,S]=u.useState([]),[s,T]=u.useState(0),[x,m]=u.useState({}),C=u.useMemo(()=>h==null?void 0:h.find(n=>n.weather_id===(_==null?void 0:_.current_weather_id)),[h,_]);function Q(){v(null)}function Y(){T(t.length-1);const n={};t.forEach(f=>{n[`${f.defender.fighter_id}-${f.defenderTeam}`]=f.defender.stats.health}),m(n)}return u.useEffect(()=>{A(d??void 0)},[d]),u.useEffect(()=>{if(a!=null&&a.team1_fighters&&(a!=null&&a.team2_fighters)){const n=a.team1_fighters.map(p=>({...p,team:1,stats:{...p.stats}})),f=a.team2_fighters.map(p=>({...p,team:2,stats:{...p.stats}})),c={};[...n,...f].forEach(p=>{c[`${p.fighter_id}-${p.team}`]=p.stats.health}),m(c);const g=ue(n,f);S(g||[]),T(0)}},[a,o]),u.useEffect(()=>{if(t.length===0||s>=t.length)return;const n=setTimeout(()=>{var $,E,y;const f=($=t==null?void 0:t[s])==null?void 0:$.attack,c=(E=t==null?void 0:t[s])==null?void 0:E.defender,g=(y=t==null?void 0:t[s])==null?void 0:y.defenderTeam;x[`${c==null?void 0:c.fighter_id}-${g}`]!==void 0&&m({...x,[`${c==null?void 0:c.fighter_id}-${g}`]:Math.max(0,x[`${c==null?void 0:c.fighter_id}-${g}`]-f)});const p=s+1;T(p)},1e3);return()=>clearTimeout(n)},[t,s,x]),u.useEffect(()=>{j.current&&(j.current.scrollTop=j.current.scrollHeight)},[s]),e.jsxs(O,{children:[e.jsx(V,{children:s>=t.length-1?e.jsx(R,{onClick:Q,children:"Back"}):e.jsx(R,{onClick:Y,children:"Skip Fight"})}),e.jsxs(U,{children:[e.jsx(N,{children:"Weather"}),e.jsx(G,{children:C==null?void 0:C.displayname}),e.jsxs(X,{children:[e.jsxs(J,{children:[e.jsxs(Z,{children:[e.jsx("span",{children:"YOUR TEAM"}),e.jsx("div",{children:a==null?void 0:a.team1_fighters.map(n=>{var f,c,g,p;return e.jsx(w,{isFighting:!0,isAttacking:((f=t==null?void 0:t[s])==null?void 0:f.attackerTeam)===1&&((c=t==null?void 0:t[s])==null?void 0:c.attacker.fighter_id)===n.fighter_id,isDefending:((g=t==null?void 0:t[s])==null?void 0:g.defenderTeam)===1&&((p=t==null?void 0:t[s])==null?void 0:p.defender.fighter_id)===n.fighter_id,fighter:{...n,stats:{...n.stats,health:x[`${n.fighter_id}-1`]}}},F())})})]}),e.jsx("span",{children:"VS"}),e.jsx(ee,{children:a==null?void 0:a.team2_fighters.map(n=>{var f,c,g,p;return e.jsxs(H,{children:[e.jsx("span",{children:"AI"}),e.jsx(w,{isFighting:!0,isAttacking:((f=t==null?void 0:t[s])==null?void 0:f.attackerTeam)===2&&((c=t==null?void 0:t[s])==null?void 0:c.attacker.fighter_id)===n.fighter_id,isDefending:((g=t==null?void 0:t[s])==null?void 0:g.defenderTeam)===2&&((p=t==null?void 0:t[s])==null?void 0:p.defender.fighter_id)===n.fighter_id,fighter:{...n,stats:{...n.stats,health:x[`${n.fighter_id}-2`]}}})]},F())})})]}),s>=t.length-1?e.jsxs(re,{children:[e.jsx(le,{children:d!=null&&d.log.includes("Team 1")?"Winner Winner, Chicken Dinner!":"You lost! "}),(d==null?void 0:d.log.includes("Team 1"))&&e.jsxs(ce,{children:[e.jsxs(z,{children:[e.jsx("img",{loading:"lazy",src:"/assets/icons/tlm.png",alt:""}),e.jsx("span",{children:r==null?void 0:r.total_tlm})]}),e.jsxs(z,{children:[e.jsx("img",{loading:"lazy",src:"/assets/icons/credit.png",alt:""}),e.jsx("span",{children:r==null?void 0:r.total_shards})]})]}),e.jsx("img",{src:`/assets/dungeon/${d!=null&&d.log.includes("Team 1")?"winner":"lost"}.png`,alt:"",loading:"lazy"}),e.jsx(oe,{children:d!=null&&d.log.includes("Team 1")?"Equip better tools to earn more instant rewards":"Looks like your fighters arenâ€™t good enough yet"})]}):e.jsx(te,{children:e.jsxs(ne,{children:[e.jsxs(ae,{children:[e.jsx("span",{children:"Attacker"}),e.jsx("span",{children:"Defender"}),e.jsx("span",{children:"Attack"}),e.jsx("span",{children:"Damage"}),e.jsx("span",{children:"Remaining Health"}),e.jsx("span",{children:"Effectiveness"}),e.jsx("span",{children:"Special Event"})]}),e.jsx(se,{ref:j,children:t.slice(0,s).map((n,f)=>e.jsxs(ie,{children:[e.jsx(w,{isFighting:!0,fighter:{...n.attacker,stats:{...n.attacker.stats,health:n.attackerHealthBefore}}}),e.jsx(w,{isFighting:!0,fighter:{...n.defender,stats:{...n.defender.stats,health:n.defenderHealthBefore-n.attack}}}),e.jsx("span",{children:n.attack}),e.jsx("span",{children:n.attacker.stats.damage}),e.jsx("span",{children:(n.defenderHealthBefore-n.attack).toFixed(2)}),e.jsxs("span",{children:[n.effectiveness.toFixed(2),"%"]}),e.jsx("span",{children:"-"}),e.jsxs("span",{children:["ID: ",n.attacker.fighter_id,e.jsx("br",{}),"TEAM: ",n.attackerTeam," "]}),e.jsxs("span",{children:["ID: ",n.defender.fighter_id,e.jsx("br",{}),"TEAM: ",n.defenderTeam]})]},f))})]})})]})]})]})};export{Ae as default};
